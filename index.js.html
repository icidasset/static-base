<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#buildDefinition">buildDefinition</a></li><li><a href="global.html#buildDependencies">buildDependencies</a></li><li><a href="global.html#buildDictionary">buildDictionary</a></li><li><a href="global.html#cleanPath">cleanPath</a></li><li><a href="global.html#run">run</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import pflow from 'pflow';

import { buildDictionary, buildDependencies } from './dictionary';
import list from './list';


/**
 * @callback runCurry
 * @param {...*} args - Opt 1, a pattern + root dir. Opt 2, a root dir. Opt 3, a dictionary. Opt 4, a promise of a dictionary.
 * @return {Promise} Returns a promise for a Dictionary
 */


/**
 * Run a sequence of functions.
 * Has support for functions that return a promise.
 * @param {...(function|Array&lt;function, *>)} sequenceItems
 * @return {runCurry}
 */
export function run(...sequenceItems) {
  return (...args) => {
    const b = args[1];

    // Resolve first argument,
    // in case it's a promise for a Dictionary
    return Promise.resolve(args[0]).then(
      (a) => _run(sequenceItems, a, b)
    );
  };
}


function _run(sequenceItems, a, b) {
  let deps, dict, pattern;

  // If given a dictionary
  if (Array.isArray(a)) {
    dict = a;

    if (dict.length >= 1) pattern = dict[0].pattern;
    else return Promise.resolve([]);

  // If given a pattern and root directory
  } else if (typeof a === 'string') {
    let root;

    if (typeof b === 'string') {
      pattern = a;
      root = b;
    } else {
      pattern = '';
      root = a;
    }

    deps = buildDependencies(pattern, root);
    dict = list(pattern, deps).then(ls => buildDictionary(ls, deps));

  // Otherwise
  } else {
    return Promise.reject('Insufficient parameters given.');

  }

  // => Run sequence
  return pflow.apply(
    null,
    sequence(sequenceItems, pattern)
  )(
    dict
  );
}


/*

Each result of the previous function
is given to the next function.

The pflow library handles the promises for this sequence.

*/


function sequence(items, pattern) {
  return items.map((item, idx) => {
    return (rvaluePrevious) => {
      const formattedItem = (typeof item === 'object' ? item : [item]);
      const fn = formattedItem[0];
      const fnArgs = [rvaluePrevious, ...formattedItem.slice(1)];

      // {check} if fn is not a function
      if (fn instanceof Function === false) {
        return Promise.reject(
          `Item ${idx + 1} in the sequence '${pattern}' is not a function`
        );
      }

      // -> continue
      const rvalueCurrent = fn.apply(null, fnArgs);

      // {check} if the same array has been returned, reject
      if (rvaluePrevious === rvalueCurrent) {
        return Promise.reject(
          `Item ${idx + 1} in the sequence '${pattern}' does not return a new array`
        );
      }

      return rvalueCurrent;
    };
  });
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Mar 28 2016 14:12:41 GMT+0200 (CEST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
